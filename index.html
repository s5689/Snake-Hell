<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="jquery-3.6.1.min.js"></script>
    <title>The Misery</title>
  </head>

  <body>
    <h1>
      Snake en <i><b>4K</b></i>
    </h1>
    <table id="game"></table>
    <h2 id="score"></h2>
  </body>
</html>

<style>
  body {
    background-color: black;
    color: white;
    text-align: -webkit-center;
    font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
  }

  #game {
    border-spacing: 0;
    border: 1px solid white;
    font-family: "Times New Roman", Times, serif;
  }

  .pixel {
    width: 12px;
    height: 12px;
    font-size: 11px;
    text-align: center;
  }
</style>

<script>
  // Variables Globales
  let dirSet = false;
  let dir = "ArrowRight";
  let score = -1;
  let x;
  let y;

  // Funcion mimir
  async function sleep(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  // Leer Teclas
  $("body").keydown((e) => {
    const key = e.key;

    if (!dirSet) {
      if (key == "ArrowUp" && dir != "ArrowDown") {
        dir = key;
        dirSet = true;
      }

      if (key == "ArrowDown" && dir != "ArrowUp") {
        dir = key;
        dirSet = true;
      }

      if (key == "ArrowRight" && dir != "ArrowLeft") {
        dir = key;
        dirSet = true;
      }

      if (key == "ArrowLeft" && dir != "ArrowRight") {
        dir = key;
        dirSet = true;
      }
    }
  });

  // Array de Mapas
  const map = [
    "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "x                         x",
    "x    ?????                x",
    "x                         x",
    "x           x             x",
    "x           x             x",
    "x           x             x",
    "x           x             x",
    "x           x             x",
    "x                   x     x",
    "x                   x     x",
    "x                   x     x",
    "x                   x     x",
    "x                   x     x",
    "x     xx xx               x",
    "x                         x",
    "x                         x",
    "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  ];

  // Renderizar Mapa
  let startPoint = null;
  let _y = 0;
  map.forEach((value) => {
    let txt = "<tr>";

    for (let _x = 0; _x < value.length; _x++) {
      let color = "black";
      if (value[_x] == "x") color = "white";
      if (value[_x] == "?") {
        x = _x;
        y = _y;
      }

      txt += "<td ";
      txt += "id='" + _x + "-" + _y + "' ";
      txt += "class='pixel' ";
      txt += "style='background-color: " + color + ";' ";
      txt += "></td>";
    }

    txt += "</tr>";
    _y++;

    $("#game").append(txt);
  });

  // App
  async function game() {
    let gameover = false;
    let player = [];
    let food = {};

    // Inicializar Jugador & food
    for (let k = 0; k < 4; k++) {
      player[k] = { x: x - k, y: y };
    }

    food = { x: x + 1, y: y };

    // Loop / Juego en curso
    while (!gameover) {
      // Limpiar buffer
      player.forEach((value) => {
        const _x = value.x;
        const _y = value.y;

        $("#" + _x + "-" + _y).attr("style", "background-color: black");
        $("#" + _x + "-" + _y).text(" ");
      });

      // Asignar direccion del jugador
      dirSet = false;

      switch (dir) {
        case "ArrowUp": {
          y--;
          break;
        }

        case "ArrowDown": {
          y++;
          break;
        }

        case "ArrowRight": {
          x++;
          break;
        }

        case "ArrowLeft": {
          x--;
          break;
        }

        default:
          break;
      }

      // Heredar posiciones de los padres / Asignar posicion actual
      if (x == food.x && y == food.y) {
        player.push({ x: x - player.length - 1, y: y });
      }

      for (let k = player.length - 1; k > 0; k--) {
        player[k].x = player[k - 1].x;
        player[k].y = player[k - 1].y;
      }

      player[0].x = x;
      player[0].y = y;

      // Posicion food + set Score
      if (x == food.x && y == food.y) {
        const xSize = map[0].length;
        const ySize = map.length;
        let oc = false;

        // Comprobar que no esta spawneando donde no deberia.
        while (!oc) {
          oc = true;

          food.x = Math.floor(Math.random() * xSize);
          food.y = Math.floor(Math.random() * ySize);

          player.forEach((value) => {
            if (value.x == food.x && value.y == food.y) oc = false;
          });

          if (map[food.y][food.x] == "x") oc = false;
        }

        score++;
        $("#score").text("Score: " + score);
      }

      // Renderizar jugador & Food
      for (let k = player.length - 1; k >= 0; k--) {
        const _x = player[k].x;
        const _y = player[k].y;
        let txt = "";

        // Color del jugador
        txt += "background-color: hsl(43, 89%, " + (38 - k) + "%);";

        // Orientacion ojitos
        if (dir == "ArrowRight" || dir == "ArrowLeft")
          txt += "writing-mode: vertical-rl;";

        // Render Player
        $("#" + _x + "-" + _y).attr("style", txt);
        if (k == 0) $("#" + _x + "-" + _y).text("• •");

        // Spawn food
        $("#" + food.x + "-" + food.y).attr("style", "color: lightpink;");
        $("#" + food.x + "-" + food.y).text("☻");
      }

      // Check Gameover
      for (let k = 1; k < player.length; k++) {
        if (player[k].x === x && player[k].y === y) gameover = true;
      }

      if (map[y][x] == "x") gameover = true;

      await sleep(150 - score * 6);
    }
  }

  game();
</script>
